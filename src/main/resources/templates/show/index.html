<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.mx/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Liste des spectacles</title>
</head>
<body>
<!-- TOUT doit être DANS ce fragment -->
<div class="max-w-7xl mx-auto px-6 py-10" layout:fragment="content">

    <!-- 1) Titre et filtre -->
    <div class="mb-10">
        <h1 class="text-4xl font-extrabold text-gray-900">Liste des spectacles</h1>
    </div>
    <form id="filter-form" class="mb-6 flex gap-3 items-center">
        <label for="tag" class="text-gray-700">Rechercher par mot-clé :</label>
        <select id="tag" name="tag" class="border rounded px-3 py-1">
            <option value="">-- Tous les spectacles --</option>
            <option th:each="t : ${availableTags}"
                    th:value="${t.tag}"
                    th:text="${t.tag}"
                    th:selected="${param.tag == t.tag}"></option>
        </select>
        <button type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Rechercher
        </button>
    </form>

    <!-- 2) Résultats et compteur -->
    <p id="result-count" class="text-sm text-gray-600 italic mb-4"></p>

    <!-- 3) Grille des cartes (remplie par JS) -->
    <div id="shows-grid"
         class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- 4) Message “aucun résultat” -->
    <div id="empty-message"
         class="hidden text-center text-gray-500 italic bg-white py-10 rounded shadow border mt-8 text-lg">
        Aucun spectacle trouvé.
    </div>

    <!-- 5) URL de l’API injectée par Thymeleaf -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const apiShowsUrl = /*[[ @{/api/v1/shows} ]]*/ '/api/v1/shows';
        /*]]>*/
    </script>

    <!-- 6) Chargement et filtrage en JS (toujours DANS le fragment) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid      = document.getElementById('shows-grid');
            const emptyMsg  = document.getElementById('empty-message');
            const resultCnt = document.getElementById('result-count');
            const form      = document.getElementById('filter-form');
            const selectTag = document.getElementById('tag');

            const params      = new URLSearchParams(window.location.search);
            const initTag     = params.get('tag')     || '';
            const initExclude = params.get('exclude') || '';
            selectTag.value   = initTag;

            function renderShowCard(show) {
                return `
            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden flex flex-col">
              <div class="h-48 bg-gray-100 flex items-center justify-center">
                ${show.posterUrl
                    ? `<img src="/images/${show.posterUrl}" alt="${show.title}"
                         class="object-contain w-full h-full p-2"/>`
                    : `<span class="text-gray-400 italic text-sm">Pas d'image</span>`}
              </div>
              <div class="p-4 flex-1 flex flex-col justify-between">
                <h2 class="text-xl font-bold text-gray-800 mb-1">${show.title}</h2>
                <div class="flex flex-wrap items-center gap-2 text-sm mb-3">
                  <span class="inline-block px-2 py-1 rounded-full text-xs font-medium
                               ${show.bookable
                    ? 'bg-green-100 text-green-700'
                    : 'bg-red-100 text-red-600'}">
                    ${show.bookable ? 'Réservable' : 'Non réservable'}
                  </span>
                  <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                    ${show.prices.length>0 ? show.prices[0]+' €' : 'Prix non défini'}
                  </span>
                  <span class="inline-block px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                    ${show.representations.length} représentation(s)
                  </span>
                </div>
                <a href="/shows/${show.id}"
                   class="inline-block text-sm text-blue-600 font-semibold hover:underline">
                  Voir les détails →
                </a>
              </div>
            </div>
          `;
            }

            function loadShows(tag = '', exclude = '') {
                let url = apiShowsUrl + (tag ? '?tag=' + encodeURIComponent(tag) : '');
                fetch(url)
                    .then(r => r.json())
                    .then(shows => {
                        if (exclude) shows = shows.filter(s => !s.tags.includes(exclude));
                        grid.innerHTML = '';
                        if (shows.length === 0) {
                            emptyMsg.classList.remove('hidden');
                            resultCnt.textContent = '0 résultat trouvé';
                        } else {
                            emptyMsg.classList.add('hidden');
                            resultCnt.textContent = `${shows.length} résultat(s) trouvé(s)`;
                            shows.forEach(s => grid.insertAdjacentHTML('beforeend', renderShowCard(s)));
                        }
                    })
                    .catch(console.error);
            }

            loadShows(initTag, initExclude);
            form.addEventListener('submit', e => {
                e.preventDefault();
                const tag = selectTag.value;
                loadShows(tag, '');
                history.replaceState(null, '', `/shows?tag=${encodeURIComponent(tag)}`);
            });
        });
    </script>

</div>
</body>
</html>
