<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.mx/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/main}">
<head>
    <title>Fiche du spectacle</title>
</head>
<body>

<!-- TOUT doit être DANS ce fragment -->
<div layout:fragment="content" class="max-w-6xl mx-auto px-6 py-12">

    <!-- 1) Titre -->
    <h1 id="show-title"
        class="text-4xl font-extrabold text-gray-900 mb-8">
    </h1>

    <!-- 2) Affiche & Infos -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        <div id="show-poster"></div>
        <div id="show-info" class="md:col-span-2 space-y-6"></div>
    </div>

    <!-- 3) Représentations -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Représentations</h2>
        <div id="reps-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    </section>

    <!-- 4) Collaborateurs -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Collaborateurs</h2>
        <div id="collab-grid"
             class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700 text-sm">
        </div>
    </section>

    <!-- 5) Mots-clés -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Mots-clés associés</h2>
        <div id="tags-container" class="flex flex-wrap gap-2 mb-4"></div>
        <div id="exclude-container" class="flex flex-wrap gap-2 mb-4"></div>
        <div sec:authorize="hasRole('ADMIN')" id="add-tag-form" class="mt-6"></div>
    </section>

    <!-- 6) Retour -->
    <div class="mt-8">
        <a href="/shows" class="text-blue-600 hover:underline">← Retour à la liste</a>
    </div>


    <!-- 7) Script JS DANS le fragment -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1) On extrait l’ID depuis l’URL /shows/{id}
            const parts  = window.location.pathname.split('/');
            const showId = parts[parts.length - 1];
            const apiUrl = `/api/v1/shows/${showId}`;

            fetch(apiUrl)
                .then(resp => {
                    if (!resp.ok) throw new Error('Spectacle introuvable');
                    return resp.json();
                })
                .then(show => {
                    // --- Titre ---
                    document.getElementById('show-title').textContent = show.title;

                    // --- Affiche ---
                    const poster = document.getElementById('show-poster');
                    poster.innerHTML = show.posterUrl
                        ? `<img src="/images/${show.posterUrl}" alt="${show.title}"
                        class="object-contain w-full h-full rounded-lg shadow"/>`
                        : `<div class="w-full aspect-[2/3] flex items-center justify-center
                           bg-gray-100 text-gray-400 rounded-lg shadow">
                   Pas d’image
                 </div>`;

                    // --- Infos principales (lieu, description, badges, bouton) ---
                    const info = document.getElementById('show-info');
                    info.innerHTML = `
              ${show.locationName ? `
                <p>
                  <span class="font-semibold text-gray-800">Lieu :</span>
                  <span class="text-gray-700">${show.locationName}</span>
                </p>` : ''}
              ${show.description ? `
                <div class="text-gray-700 leading-relaxed">
                  <h2 class="font-semibold text-gray-800 mb-2">Description</h2>
                  <p>${show.description}</p>
                </div>` : ''}
              <div class="flex flex-wrap items-center gap-4 mt-4">
                <span class="inline-block px-3 py-1 rounded-full text-sm font-medium
                             ${show.bookable
                        ? 'bg-green-100 text-green-800'
                        : 'bg-red-100 text-red-700'}">
                  ${show.bookable ? 'Réservable' : 'Non réservable'}
                </span>
                <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                  ${show.prices.length > 0 ? show.prices[0] + ' €' : 'Prix non défini'}
                </span>
                ${show.bookable
                        ? `<a href="/shows/${show.id}/reserve"
                         class="ml-auto bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                         Réserver
                       </a>`
                        : ''}
              </div>`;

                    // --- Représentations ---
                    document.getElementById('reps-grid').innerHTML =
                        show.representations.map(r => `
                <div class="p-4 rounded-lg shadow flex flex-col
                            ${r.availableSeats > 0
                            ? 'bg-green-50'
                            : 'bg-gray-200 text-gray-500'}">
                  <p class="font-medium mb-2">${new Date(r.when).toLocaleString()}</p>
                  <p class="mt-auto font-semibold text-gray-800">
                    ${r.availableSeats > 0
                            ? r.availableSeats + ' place(s) dispo'
                            : 'Complet'}
                  </p>
                </div>
              `).join('');

                    // --- Collaborateurs groupés par type ---
                    const grouped = show.collaborators.reduce((acc, c) => {
                        if (!acc[c.type]) acc[c.type] = [];
                        acc[c.type].push(c.artist);
                        return acc;
                    }, {});
                    document.getElementById('collab-grid').innerHTML =
                        Object.entries(grouped).map(([type, artists]) => `
                <div>
                  <h3 class="font-semibold mb-1">${type}</h3>
                  <ul class="list-disc list-inside">
                    ${artists.map(a => `<li>${a.firstname} ${a.lastname}</li>`).join('')}
                  </ul>
                </div>
              `).join('');

                    // --- Tags ---
                    document.getElementById('tags-container').innerHTML =
                        show.tags.map(t => `
                <a href="/shows?tag=${encodeURIComponent(t)}"
                   class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium hover:bg-yellow-200">
                  ${t}
                </a>
              `).join('');

                    // --- Exclusion par tag ---
                    document.getElementById('exclude-container').innerHTML =
                        show.tags.map(t => `
                <a href="/shows/exclude-tag/${encodeURIComponent(t)}"
                   class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium hover:bg-red-200">
                  Sans ${t}
                </a>
              `).join('');

                    // Le formulaire “Ajouter un mot-clé” peut être injecté ici pour les admins…
                })
                .catch(err => console.error(err));
        });
    </script>

</div>

</body>
</html>
